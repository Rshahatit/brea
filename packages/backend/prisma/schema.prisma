generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  firebaseUid   String   @unique
  isAnonymous   Boolean  @default(true)
  displayName   String?
  email         String?  @unique
  phone         String?  @unique
  photoUrl      String?

  // Profile data (extracted from voice/photo)
  values        String[] @default([])
  dealbreakers  String[] @default([])
  personalityTags Json?  // PersonalityTags type
  hypotheses    Json[]   @default([]) // Hypothesis[]
  knowledgeGaps Json[]   @default([]) // KnowledgeGap[]

  // Seed persona flag
  isSeed        Boolean  @default(false)

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastActiveAt  DateTime @default(now())

  // Relations
  matchesAsA    Match[]  @relation("UserA")
  matchesAsB    Match[]  @relation("UserB")
  consentEvents ConsentEvent[]
  sessions      Session[]

  @@index([firebaseUid])
  @@index([isSeed])
  @@index([lastActiveAt])
}

model Match {
  id                  String   @id @default(cuid())

  // Participants
  userAId             String
  userA               User     @relation("UserA", fields: [userAId], references: [id])
  userBId             String
  userB               User     @relation("UserB", fields: [userBId], references: [id])

  // Sandbox results
  compatibilityScore  Int      // 0-100
  confidenceLevel     String   // HIGH | MEDIUM | LOW
  whyMatched          String[]
  potentialFriction   String[]
  unknowns            Json[]   // SandboxUnknown[]
  redactedTranscript  Json[]   // TranscriptEntry[]
  safety              Json     // SafetyAssessment

  // Scenario metadata
  scenarioType        String   // e.g., "10AM_SATURDAY", "CONFLICT_RESOLUTION"

  // Status
  status              MatchStatus @default(PENDING)

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  consentEvents       ConsentEvent[]

  @@unique([userAId, userBId, scenarioType])
  @@index([userAId])
  @@index([userBId])
  @@index([status])
}

enum MatchStatus {
  PENDING
  VIEWED
  INVITED
  ACCEPTED
  DECLINED
  DATE_SCHEDULED
}

model ConsentEvent {
  id          String   @id @default(cuid())

  // Who and what
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  matchId     String
  match       Match    @relation(fields: [matchId], references: [id])

  // Event details
  eventType   String   // profile_view, transcript_view, invite_sent, etc.
  metadata    Json?

  // Timestamp
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([matchId])
  @@index([eventType])
}

model Session {
  id          String   @id @default(cuid())

  // User
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  // Session data
  transcript  Json[]   @default([]) // Full conversation history
  state       String   @default("idle") // SessionState

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  endedAt     DateTime?

  @@index([userId])
  @@index([state])
}
